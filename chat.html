<!DOCTYPE html>
<html>
<head>
  <title>Chat com Ably</title>
  <style>
    ul { list-style-type: none; margin: 0; padding: 0; }
    li { padding: 8px; margin-bottom: 10px; background: #f2f2f2; }
  </style>
</head>
<body>
  <h2>Chat com Ably</h2>
  <div>Bem-vindo, <span id="username"></span> de <span id="usercity"></span>!</div>
  <ul id="messages"></ul>
  <form id="form">
    <input id="input" autocomplete="off" /><button>Send</button>
  </form>
  <div>Usuários online: <span id="onlineCount">0</span></div>
  <!-- Ably SDK -->
  <script src="https://cdn.ably.io/lib/ably.min-1.js"></script>
  <script>
    // Recuperar dados do localStorage
    const username = localStorage.getItem('username');
    const usercity = localStorage.getItem('usercity');

    // Exibir nome e cidade na página
    document.getElementById('username').textContent = username;
    document.getElementById('usercity').textContent = usercity;

    // Conectar ao Ably com a chave de API
    const ably = new Ably.Realtime('ynrGug.SXDJOg:aoStJmyUcLlpwgEzYsJt8CFDsTBCq-yMjqNn6_DkgvM');
    const channel = ably.channels.get('chat');

    // Função para atualizar a contagem de usuários online
    function updateOnlineCount() {
      channel.presence.get((err, members) => {
        if (err) {
          console.error('Erro ao obter a contagem de usuários online:', err);
          return;
        }
        document.getElementById('onlineCount').textContent = members.length;
      });
    }

    // Entrar no canal de presença com o nome de usuário
    channel.presence.enter({ clientId: username }, (err) => {
      if (err) {
        console.error('Erro ao entrar no canal de presença:', err);
        return;
      }
      updateOnlineCount();
    });

    // Atualizar a contagem de usuários online quando alguém entra ou sai
    channel.presence.subscribe('enter', updateOnlineCount);
    channel.presence.subscribe('leave', updateOnlineCount);
    channel.presence.subscribe('update', updateOnlineCount);

    // Receber mensagens
    channel.subscribe('message', function(message) {
      const data = message.data;
      const item = document.createElement('li');
      item.textContent = `${data.name}: ${data.message}`;
      document.getElementById('messages').appendChild(item);
    });

    // Enviar mensagens
    document.getElementById('form').addEventListener('submit', function(e) {
      e.preventDefault();
      const input = document.getElementById('input');
      channel.publish('message', { name: username, message: input.value });
      input.value = '';
    });

    // Sair do canal de presença ao fechar a janela
    window.addEventListener('beforeunload', () => {
      channel.presence.leave({ clientId: username });
    });
  </script>
</body>
</html>