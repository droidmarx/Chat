<!DOCTYPE html>
<html lang="pt-br">
<head>
  
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&family=Tiny5&display=swap" rel="stylesheet">

<link rel="shortcut icon" href="https://sacbr.com.br/wp-content/uploads/2023/08/cropped-SACBR_icon.png">  

  
  
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat-Papo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .container {
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      padding: 20px;
      width: 400px;
      text-align: center;
      overflow: hidden;
    }

    h2 {
      font-family: "Play", sans-serif;
      font-weight: 400;
      font-style: normal;
      text-decoration: underline;
      font-size: 24px;
      color: #333;
      margin-bottom: 20px;
    }

    #username, #usercity {
      font-weight: bold;
      color: #4CAF50;
    }

    ul {
      list-style-type: none;
      margin: 0;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 30px 25px;
      background-color: #fff;
    }
    
    #messages>li{
      margin-right: 0px;
      width:80%;
    }

    li {
      height:fit-content ;
      max-width: 100%;
      overflow: hidden;
      padding: 10px 15px;
      margin-bottom: 20px;
      background: #f2f2f2;
      border-radius: 20px 20px 0px 20px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      word-wrap: break-word;
      word-break: break-all;
      position: relative;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    


    form {
      position: relative;
      bottom: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin:0;
    }

    input[type="text"] {
      flex: 1;
      padding: 10px;
      margin-right: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 14px;
    }

    button[type="submit"] {
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    button[type="submit"]:hover {
      background-color: #45a049;
    }

    .online-count {
      margin-top: 10px;
      font-size: 14px;
      color: #666;
    }

    .logoff-button {
      background-color: #f44336;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .logoff-button:hover {
      background-color: #d32f2f;
    }

    #input {
      padding: 10px 15px;
      margin: 0px;
      outline: none;
      border: .9px solid #B7D0BC;
    }

    #messages {
      margin: 1px;
      
    }
    
    .new-user {
      color: #4CAF50;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .message {
      width: 100%;
      text-align: left;
      margin-top: 1px;
    }
    
    .name, .min, .city{
      width: 40px;
      height: 14px;
      align-items: left;
    }
    
    .name {
     font-size: 12px;
     color: #3ABE54;
     font-weight: 900;
     width: 200px;
     text-align: left;
    }
    
    .min {
     font-size: 12px;
     color: #22AB45;
     text-align: left;
    }

    .city {
     width: 200px;
     font-size: 12px;
     color: #999;
     text-align: left;
    }
    
    #newUserAlert {
      bottom: 50px;
      height: 50px;
    }

    #newUserAlert.animate {
      animation: blurColorAnimation 1s ease-in;
    }

    @keyframes blurColorAnimation {
      0% {
        filter: blur(10px);
        opacity: 0;
        border-radius:30%;
      }
      50% {
        filter: blur(5px);
        opacity: 0.5;
      }
      100% {
        filter: blur(0px);
        opacity: 1;
      }
    }
    
    /* Estilo do botão para mostrar usuários online */
    #showOnlineUsersButton {
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      margin-top: 20px;
    }

    #showOnlineUsersButton:hover {
      background-color: #45a049;
    }

    /* Estilo da sobreposição */
    #onlineUsersOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    #overlayContent {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      position: relative;
      text-align: center;
    }

    #closeOverlayButton {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #f44336;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      padding: 5px 10px;
    }

    #closeOverlayButton:hover {
      background-color: #d32f2f;
    }

    #onlineUsersList {
      list-style-type: none;
      padding: 0;
      margin-top: 20px;
    }

    #onlineUsersList li {
      background: #f2f2f2;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
    }

    h2 {
      font-family: "Play", sans-serif;
      font-weight: 400;
      font-style: normal;
      text-decoration: underline;
    }

    span {
      font-weight: bold;
      color: #4CAF50;
    }
  </style>
</head>
<body>
  
  <div class="container">
    <h2>Chat<span>-</span>Opap</h2>
    <h4>o Chat ao contrário</h4>
    
    <div>Bem-vindo, <span id="username"></span> de <span id="usercity"></span>!</div>
      <!-- Botão para mostrar usuários online -->
<button id="showOnlineUsersButton">Quem ta Online ?</button>

    <div class="online-count">Usuários na sala: <span id="onlineCount">0</span>

    <ul id="messages"></ul>
    
    <form id="form">
      <input id="input" autocomplete="off" placeholder="Digite sua mensagem..." />
      <button id="submitButton" type="submit">Entrar</button>
    </form>

    
    <div id="newUserAlert"></div>
    
    <audio id="newUserSound" style="display: none" src="/audio/crystal_sound_crash.mp3" controls></audio>
    
  <audio id="messageSound" style="display: none" src="/audio/email_entact.mp3" controls></audio>

    
    <button class="logoff-button" onclick="logoff()">Sair do Chat</button>
  </div>

<!-- Sobreposição de usuários online -->
<div id="onlineUsersOverlay">
  <div id="overlayContent">
    <button id="closeOverlayButton">X</button>
    <h3>Usuários Online</h3>
    <ul id="onlineUsersList"></ul>
  </div>
</div>


  <!-- Ably SDK -->
  <script src="https://cdn.ably.io/lib/ably.min-1.js"></script>
  <script>
// Função para inverter uma string
function reverseString(str) {
  return str.split('').reverse().join('');
}

// Recuperar dados do localStorage
const username = localStorage.getItem('username');
const usercity = localStorage.getItem('usercity');

// Verificar se há nome de usuário no localStorage
if (!username) {
  // Redirecionar de volta ao index se não houver nome de usuário
  window.location.href = 'index.html';
}

// Exibir nome e cidade na página
document.getElementById('username').textContent = username || 'Anônimo';
document.getElementById('usercity').textContent = usercity || 'Desconhecida';

// Conectar ao Ably com a chave de API e o clientId (token aleatório)
const clientId = localStorage.getItem('clientId') || generateRandomToken(32);
localStorage.setItem('clientId', clientId); // Armazenar clientId no localStorage
const ably = new Ably.Realtime({
  key: 'ynrGug.SXDJOg:aoStJmyUcLlpwgEzYsJt8CFDsTBCq-yMjqNn6_DkgvM',
  clientId: clientId
});
const channel = ably.channels.get('chat');

// Função para atualizar a contagem de usuários online
function updateOnlineCount() {
  channel.presence.get((err, members) => {
    if (err) {
      console.error('Erro ao obter a contagem de usuários online:', err);
      return;
    }
    document.getElementById('onlineCount').textContent = members.length;
  });
}

// Entrar no canal de presença com o clientId (token aleatório)
function enterPresence() {
  channel.presence.enter({ name: username, city: usercity }, (err) => {
    if (err) {
      console.error('Erro ao entrar no canal de presença:', err);
      return;
    }
    updateOnlineCount();
  });
}

// Atualizar a contagem de usuários online quando alguém entra ou sai
channel.presence.subscribe('enter', member => {
  updateOnlineCount();
  displayNewUserAlert(member);
});
channel.presence.subscribe('leave', updateOnlineCount);
channel.presence.subscribe('update', updateOnlineCount);

channel.subscribe('message', function(message) {
  const data = message.data;
  const item = document.createElement('li');
  const messageTime = new Date(message.timestamp);
  const timeString = `${formatTime(messageTime.getHours())}:${formatTime(messageTime.getMinutes())}`;
  
  // Inverte o nome antes de exibir
  const reversedName = reverseString(data.name);
  
  const reversedCity = reverseString(data.city);
  const reversedMessage = reverseString(data.message);


  item.innerHTML = `
    <span class="min">${timeString}</span>
    <span class="city">${data.city}</span>
    <span class="name">${data.name} :</span>
    <span class="message">${wrapText(reversedMessage, 32)}</span>`;

  document.getElementById('messages').appendChild(item);
  document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight; // Scroll para o final

  // Tocar som de mensagem
  document.getElementById('messageSound').play();
});

// Variável para controlar o estado do chat
let chatStarted = false;

// Função para exibir alerta de novo usuário
function displayNewUserAlert(member) {
  const newUserAlert = document.getElementById('newUserAlert');
  const newUserSound = document.getElementById('newUserSound');

  newUserAlert.innerHTML = `<div class="new-user">${member.data.name} de ${member.data.city}</div>Entrou na sala`;
  newUserSound.play();

  // Adiciona a classe para iniciar a animação
  newUserAlert.classList.add('animate');

  setTimeout(() => {
    // Remove o conteúdo e a classe após 5 segundos
    newUserAlert.innerHTML = '';
    newUserAlert.classList.remove('animate');
  }, 5000); // Remove o alerta após 5 segundos
}

// Função para dividir o texto em várias linhas com um comprimento máximo especificado
function wrapText(text, maxLineLength) {
  const words = text.split(' ');
  let line = '';
  let result = '';

  for (const word of words) {
    if (line.length + word.length + 1 > maxLineLength) {
      result += line + '<br>';
      line = word;
    } else {
      line += (line ? ' ' : '') + word;
    }
  }

  return result + line;
}

// Função para enviar mensagens
function sendMessage() {
  const input = document.getElementById('input');
  if (input.value.trim() === '') return; // Evitar mensagens vazias

  channel.publish('message', {
    name: username || 'Anônimo',
    city: usercity || 'Desconhecida',
    message: input.value.trim()
  });

  input.value = '';
}

// Função para iniciar o chat
function startChat() {
  enterPresence();
  chatStarted = true;

  // Envia a mensagem digitada ao entrar
  sendMessage();

  // Muda o texto do botão para "Enviar"
  const submitButton = document.getElementById('submitButton');
  submitButton.textContent = 'Enviar';

  // Muda o evento de submit do formulário para apenas enviar mensagem
  document.getElementById('form').addEventListener('submit', function(e) {
    e.preventDefault();
    sendMessage();
  });
}

// Função para logoff (limpar localStorage e redirecionar para a página inicial)
function logoff() {
  localStorage.clear();
  window.location.href = 'index.html';
}

// Adicionar evento de clique ao botão de envio
document.getElementById('form').addEventListener('submit', function(e) {
  e.preventDefault();
  if (!chatStarted) {
    startChat();
  } else {
    sendMessage();
  }
});

// Sair do canal de presença ao fechar a janela
window.addEventListener('beforeunload', () => {
  channel.presence.leave({ name: username, city: usercity });
});

// Função para gerar token aleatório
function generateRandomToken(length) {
  let charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let token = '';
  let values = new Uint32Array(length);
  window.crypto.getRandomValues(values);
  for (let i = 0; i < length; i++) {
    token += charset[values[i] % charset.length];
  }
  return token;
}

// Função para formatar o tempo (adicionar zero à esquerda se for menor que 10)
function formatTime(time) {
  return time < 10 ? `0${time}` : time;
}

// Função para mostrar a sobreposição de usuários online
function showOnlineUsers() {
  const overlay = document.getElementById('onlineUsersOverlay');
  const userList = document.getElementById('onlineUsersList');
  userList.innerHTML = ''; // Limpar a lista

  // Obter membros da presença e exibi-los na lista
  channel.presence.get((err, members) => {
    if (err) {
      console.error('Erro ao obter usuários online:', err);
      return;
    }

    members.forEach(member => {
      const listItem = document.createElement('li');
      listItem.textContent = `${member.data.name} de ${member.data.city}`;
      userList.appendChild(listItem);
    });

    overlay.style.display = 'flex';
  });
}

// Função para ocultar a sobreposição de usuários online
function closeOverlay() {
  const overlay = document.getElementById('onlineUsersOverlay');
  overlay.style.display = 'none';
}

// Adicionar eventos aos botões
document.getElementById('showOnlineUsersButton').addEventListener('click', showOnlineUsers);
document.getElementById('closeOverlayButton').addEventListener('click', closeOverlay);


</script>
</body>
</html>
