<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat-ON</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .container {
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      padding: 20px;
      width: 400px;
      text-align: center;
      overflow: hidden;
    }

    h2 {
      font-size: 24px;
      color: #333;
      margin-bottom: 20px;
    }

    #username, #usercity {
      font-weight: bold;
      color: #4CAF50;
    }

    ul {
      list-style-type: none;
      margin: 0;
      max-height: 300px;
      overflow-y: auto;
      border: .5px solid #ccc;
      border-radius: 4px;
      padding: 30px 25px;
      background-color: #fff;
      animation: pulse 1s infinite alternate;
    }

    @keyframes pulse {
      0% {
        border-color: #ccc;
      }
      100% {
        border-color: #4CAF50;
      }
    }

    li {
      max-width: 100%;
      overflow: hidden;
      padding: 8px;
      margin-bottom: 10px;
      background: #f2f2f2;
      border-radius: 4px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      word-wrap: break-word;
      word-break: break-all;
    }

    .city {
      font-size: 12px;
      color: #999;
      padding: 2px;
    }

    form {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 20px;
    }

    input[type="text"] {
      flex: 1;
      padding: 10px;
      margin-right: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 14px;
    }

    button[type="submit"] {
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    button[type="submit"]:hover {
      background-color: #45a049;
    }

    .online-count {
      margin-top: 10px;
      font-size: 14px;
      color: #666;
    }

    .logoff-button {
      background-color: #f44336;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .logoff-button:hover {
      background-color: #d32f2f;
    }

    #input {
      padding: 10px 20px;
      margin: 10px;
    }

    #messages {
      margin: 10px;
    }
    .message-info{
      font-size: 12px;
      color: #22AB45;
      align-items: left;
    }
    
    .name{
      color: #949E96;
      font-weight: 900;
      align-items: left;
    }
    
    .new-user {
      color: #4CAF50;
      font-weight: bold;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Chat-<span id="on">ON</span></h2>
    <div>Bem-vindo, <span id="username"></span> de <span id="usercity"></span>!</div>
    <div id="newUserAlert"></div>
    <ul id="messages"></ul>
    <form id="form">
      <input id="input" autocomplete="off" placeholder="Digite sua mensagem..." />
      <button type="submit">Enviar</button>
    </form>
    <div class="online-count">Usuários online: <span id="onlineCount">0</span></div>
    <button class="logoff-button" onclick="logoff()">Sair do Chat</button>
  </div>

  <!-- Ably SDK -->
  <script src="https://cdn.ably.io/lib/ably.min-1.js"></script>
  <script>
    // Recuperar dados do localStorage
    const username = localStorage.getItem('username');
    const usercity = localStorage.getItem('usercity');

    // Verificar se há nome de usuário no localStorage
    if (!username) {
      // Redirecionar de volta ao index se não houver nome de usuário
      window.location.href = 'index.html';
    }

    // Exibir nome e cidade na página
    document.getElementById('username').textContent = username || 'Anônimo';
    document.getElementById('usercity').textContent = usercity || 'Desconhecida';

    // Conectar ao Ably com a chave de API e o clientId (token aleatório)
    const clientId = localStorage.getItem('clientId') || generateRandomToken(32);
    localStorage.setItem('clientId', clientId); // Armazenar clientId no localStorage
    const ably = new Ably.Realtime({
      key: 'ynrGug.SXDJOg:aoStJmyUcLlpwgEzYsJt8CFDsTBCq-yMjqNn6_DkgvM',
      clientId: clientId
    });
    const channel = ably.channels.get('chat');

    // Função para atualizar a contagem de usuários online
    function updateOnlineCount() {
      channel.presence.get((err, members) => {
        if (err) {
          console.error('Erro ao obter a contagem de usuários online:', err);
          return;
        }
        document.getElementById('onlineCount').textContent = members.length;
      });
    }

    // Entrar no canal de presença com o clientId (token aleatório)
    channel.presence.enter({ name: username, city: usercity }, (err) => {
      if (err) {
        console.error('Erro ao entrar no canal de presença:', err);
        return;
      }
      updateOnlineCount();
    });

    // Atualizar a contagem de usuários online quando alguém entra ou sai
    channel.presence.subscribe('enter', member => {
      updateOnlineCount();
      displayNewUserAlert(member);
    });
    channel.presence.subscribe('leave', updateOnlineCount);
    channel.presence.subscribe('update', updateOnlineCount);

    channel.subscribe('message', function(message) {
      const data = message.data;
      const item = document.createElement('li');
      const messageTime = new Date(message.timestamp);
      const timeString = `${formatTime(messageTime.getHours())}:${formatTime(messageTime.getMinutes())}`;

      // Alterando a ordem para colocar as horas (timeString) no final
      item.innerHTML = `
      <span class="message-info">
      ${timeString}
      </span> 
      
      <span class="city">
      ${data.city}
      </span>
      
      <span class="name">
      ${data.name} : 
      </span>
    
      ${wrapText(data.message, 32)}`;

      document.getElementById('messages').appendChild(item);
      document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight; // Scroll para o final
    });

    // Função para exibir alerta de novo usuário
    function displayNewUserAlert(member) {
      const newUserAlert = document.getElementById('newUserAlert');
      newUserAlert.innerHTML = `<div class="new-user">${member.data.name} de ${member.data.city}</div>Entrou !`;
      setTimeout(() => {
        newUserAlert.innerHTML = '';
      }, 5000); // Remove o alerta após 5 segundos
    }

    // Função para dividir o texto em várias linhas com um comprimento máximo especificado
    function wrapText(text, maxLineLength) {
      const words = text.split(' ');
      let line = '';
      let result = '';

      for (const word of words) {
        if (line.length + word.length + 1 > maxLineLength) {
  result += line + '<br>';
  line = word;
} else {
  line += (line ? ' ' : '') + word;
}
}

return result + line;
}

// Enviar mensagens
document.getElementById('form').addEventListener('submit', function(e) {
  e.preventDefault();
  const input = document.getElementById('input');
  if (input.value.trim() === '') return; // Evitar mensagens vazias
  channel.publish('message', {
    name: username || 'Anônimo',
    city: usercity || 'Desconhecida',
    message: input.value.trim()
  });
  input.value = '';
});

// Sair do canal de presença ao fechar a janela
window.addEventListener('beforeunload', () => {
  channel.presence.leave({ name: username, city: usercity });
});

// Função para gerar token aleatório
function generateRandomToken(length) {
  let charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let token = '';
  let values = new Uint32Array(length);
  window.crypto.getRandomValues(values);
  for (let i = 0; i < length; i++) {
    token += charset[values[i] % charset.length];
  }
  return token;
}

// Função para formatar o tempo (adicionar zero à esquerda se for menor que 10)
function formatTime(time) {
  return time < 10 ? `0${time}` : time;
}

// Função para logoff (limpar localStorage e redirecionar para a página inicial)
function logoff() {
  localStorage.clear();
  window.location.href = 'index.html';
}
</script>
</body> 
</html>